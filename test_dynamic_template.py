#!/usr/bin/env python3\n\"\"\"\nTest script for SendGrid Dynamic Template functionality.\nThis script tests the updated email functions to ensure they work with your\nSendGrid dynamic template without JSON serialization errors.\n\"\"\"\n\nimport os\nimport sys\nfrom datetime import datetime\n\n# Add project root to path\nsys.path.append(os.path.dirname(os.path.abspath(__file__)))\n\nfrom email_utils.sendgrid_client import send_test_email, send_trade_email\nfrom dynamic_trading_emailer import DynamicTradingEmailer\n\ndef test_basic_template():\n    \"\"\"Test the basic sendgrid_client template functionality\"\"\"\n    print(\"\ud83e\uddea Testing basic SendGrid dynamic template...\")\n    print(\"=\" * 50)\n    \n    result = send_test_email(\"This is a test of the dynamic template system\")\n    \n    if result.get(\"success\"):\n        print(\"\u2705 SUCCESS: Basic template test passed!\")\n        print(f\"   Status Code: {result.get('status_code')}\")\n        print(f\"   Message: {result.get('message')}\")\n        print(f\"   Template ID: {result.get('template_id')}\")\n        print(f\"   Trade ID: {result.get('trade_id')}\")\n    else:\n        print(\"\u274c FAILED: Basic template test failed\")\n        print(f\"   Error: {result.get('error')}\")\n    \n    return result.get(\"success\", False)\n\ndef test_dynamic_emailer():\n    \"\"\"Test the DynamicTradingEmailer template functionality\"\"\"\n    print(\"\\n\ud83e\uddea Testing DynamicTradingEmailer with template...\")\n    print(\"=\" * 50)\n    \n    emailer = DynamicTradingEmailer()\n    \n    if not emailer.is_configured():\n        print(\"\u274c Email not configured! Check your .env file\")\n        return False\n    \n    # Test with sample trade data\n    sample_trade = {\n        'trade_id': 'TEST-DYNAMIC',\n        'ticker': 'BTCUSD',\n        'direction': 'long',\n        'entry_price': 45000.00,\n        'exit_price': 46500.00,\n        'pnl': '+1500.00 USD',\n        'pnl_amount': 1500.00,\n        'date_time': '2025-07-08 15:30:00',\n        'timeframe': '1h',\n        'reason_or_annotations': 'Breakout trade with strong volume',\n        'ocr_confidence': '92.5%'\n    }\n    \n    summary = \"\"\"\nTEST TRADE ANALYSIS\n\nThis is a test of the dynamic template system.\nThe trade data should be properly formatted in the email template.\n\nKey Features Tested:\n- JSON serialization (no bytes)\n- Template variable substitution\n- Trade data display\n- Summary formatting\n    \"\"\".strip()\n    \n    result = emailer.send_email_with_template(sample_trade, summary)\n    \n    if result.get(\"success\"):\n        print(\"\u2705 SUCCESS: Dynamic emailer template test passed!\")\n        print(f\"   Status Code: {result.get('status_code')}\")\n        print(f\"   Message: {result.get('message')}\")\n        print(f\"   Template ID: {result.get('template_id')}\")\n    else:\n        print(\"\u274c FAILED: Dynamic emailer template test failed\")\n        print(f\"   Error: {result.get('error')}\")\n    \n    return result.get(\"success\", False)\n\ndef test_latest_trade_alert():\n    \"\"\"Test sending an alert for the latest trade (if any exist)\"\"\"\n    print(\"\\n\ud83e\uddea Testing latest trade alert with template...\")\n    print(\"=\" * 50)\n    \n    emailer = DynamicTradingEmailer()\n    \n    result = emailer.send_latest_trade_alert()\n    \n    if result.get(\"success\"):\n        print(\"\u2705 SUCCESS: Latest trade alert sent!\")\n        print(f\"   Status Code: {result.get('status_code')}\")\n        print(f\"   Message: {result.get('message')}\")\n        print(f\"   Template ID: {result.get('template_id')}\")\n    else:\n        print(\"\u2139\ufe0f  INFO: Latest trade alert not sent\")\n        print(f\"   Reason: {result.get('error')}\")\n        if \"No trades found\" in str(result.get('error')):\n            print(\"   This is normal if you haven't uploaded any trades yet.\")\n    \n    return result.get(\"success\", False)\n\ndef check_environment():\n    \"\"\"Check if required environment variables are set\"\"\"\n    print(\"\ud83d\udd27 Checking environment configuration...\")\n    print(\"=\" * 50)\n    \n    required_vars = ['SENDGRID_API_KEY', 'FROM_EMAIL', 'TO_EMAIL']\n    missing_vars = []\n    \n    for var in required_vars:\n        value = os.getenv(var)\n        if value:\n            # Show partial value for security\n            if 'API_KEY' in var:\n                display_value = value[:8] + '...' if len(value) > 8 else value\n            else:\n                display_value = value\n            print(f\"\u2705 {var}: {display_value}\")\n        else:\n            print(f\"\u274c {var}: NOT SET\")\n            missing_vars.append(var)\n    \n    if missing_vars:\n        print(f\"\\n\u26a0\ufe0f  Missing environment variables: {', '.join(missing_vars)}\")\n        print(\"Please check your .env file\")\n        return False\n    else:\n        print(\"\\n\u2705 All required environment variables are set!\")\n        return True\n\ndef main():\n    \"\"\"Run all tests\"\"\"\n    print(\"\ud83d\ude80 SendGrid Dynamic Template Test Suite\")\n    print(\"Template ID: d-ec19e26ba3254d9419ebe5a0dfb3f90\")\n    print(\"Template Name: Trade-detail\")\n    print(\"=\" * 60)\n    \n    # Check environment first\n    if not check_environment():\n        print(\"\\n\u274c Environment check failed. Cannot proceed with tests.\")\n        return\n    \n    # Run tests\n    tests_passed = 0\n    total_tests = 0\n    \n    # Test 1: Basic template\n    total_tests += 1\n    if test_basic_template():\n        tests_passed += 1\n    \n    # Test 2: Dynamic emailer\n    total_tests += 1\n    if test_dynamic_emailer():\n        tests_passed += 1\n    \n    # Test 3: Latest trade alert (optional)\n    total_tests += 1\n    if test_latest_trade_alert():\n        tests_passed += 1\n    \n    # Summary\n    print(\"\\n\" + \"=\" * 60)\n    print(\"\ud83d\udcca TEST SUMMARY\")\n    print(\"=\" * 60)\n    print(f\"Tests Passed: {tests_passed}/{total_tests}\")\n    print(f\"Success Rate: {(tests_passed/total_tests*100):.1f}%\")\n    \n    if tests_passed >= 2:  # At least basic tests should pass\n        print(\"\\n\ud83c\udf89 OVERALL SUCCESS: Dynamic template is working!\")\n        print(\"\\n\ud83d\udce7 What this means:\")\n        print(\"   \u2705 No more 'bytes not JSON serializable' errors\")\n        print(\"   \u2705 Your SendGrid dynamic template is receiving proper data\")\n        print(\"   \u2705 Email sending is functional\")\n        print(\"\\n\ud83d\udca1 Next steps:\")\n        print(\"   1. Upload a trade screenshot via your web dashboard\")\n        print(\"   2. Enable email alerts in the upload form\")\n        print(\"   3. Check your email for the formatted trade summary\")\n    else:\n        print(\"\\n\u26a0\ufe0f  SOME TESTS FAILED\")\n        print(\"\\n\ud83d\udd27 Troubleshooting:\")\n        print(\"   1. Check your .env file for correct API keys\")\n        print(\"   2. Verify SendGrid template ID is correct\")\n        print(\"   3. Ensure your SendGrid account is active\")\n        print(\"   4. Check SendGrid logs for delivery issues\")\n    \n    print(\"\\n\ud83d\udcde Need help? Check the error messages above for details.\")\n\nif __name__ == \"__main__\":\n    main()\n